{% extends "layouts/base_app.html" %}
{% load i18n %}
{% load money %}

{% block title %}{% trans "Movimientos" %} Â· Finanzas Bot{% endblock %}

{% block content %}
<div class="space-y-6">

  <div class="flex flex-col sm:flex-row gap-3 sm:items-center sm:justify-between">
    <div>
      <h1 class="text-2xl font-semibold">ğŸ“’ {% trans "Movimientos" %}</h1>
      <p class="text-slate-300 text-sm">{% trans "Transacciones registradas (web y Telegram)." %}</p>
    </div>

    <a href="{% url 'transactions:create' %}"
       class="inline-flex items-center justify-center rounded-2xl border border-white/10 bg-white/10 hover:bg-white/15 px-4 py-2 text-sm">
      â• {% trans "Nuevo movimiento" %}
    </a>
  </div>

  <!-- Filtros -->
  <form method="get" class="rounded-3xl border border-white/10 bg-white/5 p-4">
    <div class="grid md:grid-cols-6 gap-3">

      <div>
        <label class="text-xs text-slate-300">{% trans "Tipo" %}</label>
        <select name="kind" class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
          <option value="">{% trans "Todos" %}</option>
          <option value="expense" {% if kind == "expense" %}selected{% endif %}>{% trans "Gasto" %}</option>
          <option value="income" {% if kind == "income" %}selected{% endif %}>{% trans "Ingreso" %}</option>
        </select>
      </div>

      <div>
        <label class="text-xs text-slate-300">{% trans "Moneda" %}</label>
        <select name="cur" class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
          <option value="">{% trans "Todas" %}</option>
          <option value="CLP" {% if cur == "CLP" %}selected{% endif %}>CLP</option>
          <option value="USD" {% if cur == "USD" %}selected{% endif %}>USD</option>
        </select>
      </div>

      <!-- âœ… NUEVO: filtro tarjeta -->
      <div>
        <label class="text-xs text-slate-300">{% trans "Tarjeta" %}</label>
        <select name="card" class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
          <option value="">{% trans "Todas las tarjetas" %}</option>
          {% for c in cards %}
            <option value="{{ c.id }}"
                    {% if card_id|default:'' == c.id|stringformat:"s" %}selected{% endif %}>
              {{ c.name }}{% if c.last4 %} â€¢ ****{{ c.last4 }}{% endif %}
            </option>
          {% endfor %}
        </select>
      </div>

      <div>
        <label class="text-xs text-slate-300">{% trans "Desde" %}</label>
        <input type="date" name="from" value="{{ date_from }}"
               class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
      </div>

      <div>
        <label class="text-xs text-slate-300">{% trans "Hasta" %}</label>
        <input type="date" name="to" value="{{ date_to }}"
               class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
      </div>

      <div>
        <label class="text-xs text-slate-300">{% trans "Buscar" %}</label>
        <input type="text" name="q" value="{{ q }}" placeholder="{% trans 'Uber, sueldo, etc.' %}"
               class="w-full rounded-xl bg-slate-950/40 border border-white/10 px-3 py-2 text-sm">
      </div>

    </div>

    <div class="mt-3 flex gap-2">
      <button class="rounded-2xl border border-white/10 bg-white/10 hover:bg-white/15 px-4 py-2 text-sm">
        ğŸ” {% trans "Filtrar" %}
      </button>
      <a href="{% url 'transactions:list' %}"
         class="rounded-2xl border border-white/10 bg-transparent hover:bg-white/5 px-4 py-2 text-sm">
        {% trans "Limpiar" %}
      </a>
    </div>
  </form>

  <!-- Tabla -->
  <div class="overflow-x-auto rounded-3xl border border-white/10 bg-slate-950/40">
    <table class="min-w-full text-sm">
      <thead class="border-b border-white/10 bg-slate-950/60">
        <tr>
          <th class="text-left p-3">{% trans "Fecha" %}</th>
          <th class="text-left p-3">{% trans "Tipo" %}</th>
          <th class="text-left p-3">{% trans "DescripciÃ³n" %}</th>
          <th class="text-left p-3">{% trans "Tarjeta" %}</th> <!-- âœ… NUEVO -->
          <th class="text-right p-3">{% trans "Original" %}</th>
          <th class="text-right p-3">{% trans "CLP base" %}</th>
          <th class="text-right p-3">{% trans "Acciones" %}</th>
        </tr>
      </thead>
      <tbody>
        {% for t in page.object_list %}
          <tr class="border-b border-white/5">
            <td class="p-3 text-slate-300">{{ t.occurred_at|date:"Y-m-d H:i" }}</td>

            <td class="p-3">
              {% if t.kind == "expense" %}
                <span class="px-2 py-1 rounded-lg bg-rose-500/15 border border-rose-500/30">ğŸ§¾ {% trans "Gasto" %}</span>
              {% else %}
                <span class="px-2 py-1 rounded-lg bg-emerald-500/15 border border-emerald-500/30">ğŸ’° {% trans "Ingreso" %}</span>
              {% endif %}
            </td>

            <td class="p-3 text-slate-200">{{ t.description|default:"â€”" }}</td>

            <!-- âœ… NUEVO: tarjeta -->
            <td class="p-3 text-slate-200">
              {% if t.card %}
                {{ t.card.name }}{% if t.card.last4 %} â€¢ ****{{ t.card.last4 }}{% endif %}
              {% else %}
                <span class="text-slate-400">â€”</span>
              {% endif %}
            </td>

            <td class="p-3 text-right font-semibold">
              {{ t.amount_original|money:t.currency_original }}
              <span class="text-slate-300 font-normal">{{ t.currency_original }}</span>
            </td>

            <td class="p-3 text-right font-semibold">
              {{ t.amount_clp|money:"CLP" }}
              <span class="text-slate-300 font-normal">CLP</span>
            </td>
<td class="p-3 text-right">
  <div class="inline-flex items-center gap-3 justify-end">
    <a href="{% url 'transactions:edit' t.id %}"
       class="text-sky-300 hover:text-sky-200 text-sm">
      âœï¸ {% trans "Editar" %}
    </a>

    <form method="post" action="{% url 'transactions:delete' t.id %}" class="inline">
      {% csrf_token %}
      <button class="text-rose-300 hover:text-rose-200 text-sm"
              onclick="return confirm('{% trans "Â¿Eliminar este movimiento?" %}');">
        ğŸ—‘ï¸ {% trans "Borrar" %}
      </button>
    </form>
  </div>
</td>
          </tr>
        {% empty %}
          <tr>
            <td colspan="7" class="p-4 text-slate-300">{% trans "AÃºn no tienes movimientos." %}</td>
          </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>

  <!-- PaginaciÃ³n -->
  {% if page.paginator.num_pages > 1 %}
    <div class="flex items-center justify-between text-sm text-slate-300">
      <div>
        {% blocktrans with number=page.number total=page.paginator.num_pages %}
          PÃ¡gina {{ number }} de {{ total }}
        {% endblocktrans %}
      </div>
      <div class="flex gap-2">
        {% if page.has_previous %}
          <a class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5"
             href="?page={{ page.previous_page_number }}&kind={{ kind }}&cur={{ cur }}&card={{ card_id }}&q={{ q }}&from={{ date_from }}&to={{ date_to }}">
            â†
          </a>
        {% endif %}
        {% if page.has_next %}
          <a class="px-3 py-2 rounded-xl border border-white/10 hover:bg-white/5"
             href="?page={{ page.next_page_number }}&kind={{ kind }}&cur={{ cur }}&card={{ card_id }}&q={{ q }}&from={{ date_from }}&to={{ date_to }}">
            â†’
          </a>
        {% endif %}
      </div>
    </div>
  {% endif %}

</div>
{% endblock %}